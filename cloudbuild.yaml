steps:

# get YouTube API key from storage
- name: 'gcr.io/cloud-builders/gsutil'
  id: copy_api_key
  args: ['-q', 'cp', 'gs://watchlater-build-config/apikey.xml', 'app/src/main/res/values/']

# build the project
- name: 'gcr.io/$PROJECT_ID/android:31'
  id: build
  args: ["./gradlew", "assembleDebug", "lint", "test"]
  env:
    - 'TERM=dumb'
    - 'JAVA_TOOL_OPTIONS="-Xmx3g"'
    - 'GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=8 -Dkotlin.incremental=false"'
    - 'BRANCH_NAME=$BRANCH_NAME'
  waitFor:
    - copy_api_key

# save APK
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['-q', 'cp', '-r', 'app/build/outputs/apk', 'gs://watchlater-build-artifacts/$BRANCH_NAME-$BUILD_ID/']
  waitFor: ['build']

timeout: 1800s
